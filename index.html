<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Трекер долгов и финансовой подушки</title>

<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{--bg:#f4f6fa;--br:#bac3d6;--blue:#4e7ef8}
*{box-sizing:border-box;font-family:system-ui,Arial,sans-serif}
body{margin:0;background:var(--bg);color:#111;padding:1rem;font-size:15px}
h1{margin:0 0 .8rem;font-size:1.3rem}
#wrapper{max-width:1500px;margin:auto}
button{margin:.35rem .2rem;padding:.45rem .8rem;border:1px solid var(--blue);
  background:var(--blue);color:#fff;border-radius:4px;font-size:.8rem;cursor:pointer}
button.secondary{background:#fff;color:var(--blue)}
#tblWrap{overflow-x:auto;margin-top:.6rem}
table{border-collapse:collapse;width:100%;min-width:1200px;font-size:.78rem}
th,td{border:1px solid var(--br);padding:2px 4px;text-align:right;white-space:nowrap}
th{background:#e6ecf5;position:sticky;top:0;z-index:1}
th.plan{background:#d8eaff}   th.fact{background:#ffe5d6}
td.edit{cursor:pointer} td.edit:focus{outline:2px solid var(--blue);background:#fff}
#charts{display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem}
canvas{background:#fff;border:1px solid var(--br);padding:.3rem;width:100%;max-width:600px;height:320px}
@media(max-width:700px){
  table{font-size:.72rem;min-width:900px}
  canvas{height:260px}
}
.hidden{display:none}
</style>
</head>
<body>
<div id="wrapper">
  <h1>Трекер долгов и финансовой подушки</h1>

  <button id="saveBtn">Сохранить</button>
  <button id="exportBtn" class="secondary">Экспорт CSV</button>
  <button id="resetBtn"  class="secondary">Сбросить</button>

  <div id="tblWrap"></div>
  <div id="charts" class="hidden">
    <canvas id="debtChart"></canvas>
    <canvas id="reserveChart"></canvas>
  </div>
</div>

<script>
/* ---------- 1. ПЛАН (формируем программно, чтобы не было «обрыва») ---------- */
function buildPlan(){
  const rows=[];
  rows.push({m:"Jul 2025",ps5:28000,crMin:10000,crX:30000,auto:0,autoX:0,mom:0,par:0,rez:50000});

  rows.push({m:"Aug 2025",ps5:0,crMin:10000,crX:50000,auto:35000,autoX:0,mom:0,par:0,rez:10000});
  rows.push({m:"Sep 2025",ps5:0,crMin:10000,crX:50000,auto:35000,autoX:0,mom:0,par:0,rez:10000});
  rows.push({m:"Oct 2025",ps5:0,crMin:30000,crX:0,auto:35000,autoX:0,mom:0,par:0,rez:10000});

  /* Nov-25 → Jun-26 — 8 мес., авто 35 + 50, подушка 10 */
  for(let i=0;i<8;i++){
    rows.push(buildRow(2025,10+i,35000,50000,10000));
  }
  /* Jul-26 → Sep-27 — 15 мес., авто 35 + 50, подушка 15 */
  for(let i=0;i<15;i++){
    rows.push(buildRow(2026,6+i,35000,50000,15000));
  }
  /* Oct-27 → May-28 — 8 мес., маме 50, подушка 30 */
  for(let i=0;i<8;i++){
    rows.push(buildRow(2027,9+i,0,0,30000,50000,0));
  }
  /* Jun-28 → Feb-29 — 9 мес., родителям 50, подушка 30 */
  for(let i=0;i<9;i++){
    rows.push(buildRow(2028,5+i,0,0,30000,0,50000));
  }
  return rows;

  function buildRow(y,mon,auto,autoX,rez,mom=0,par=0){
    return {
      m:new Date(y,mon,1).toLocaleString('en',{month:'short',year:'numeric'}).replace(' ',' '),
      ps5:0,crMin:0,crX:0,auto,autoX,mom,par,rez
    }
  }
}
const planRows=buildPlan();

/* ---------- 2. Константы + начальные балансы ---------- */
const INIT_BAL={ps5:28000,credit:170000,auto:1500000,mom:400000,par:500000,
                mortgage:2850508,reserve:0};
const MORTGAGE=20500;
const columns=[
  {k:'ps5', t:'PS5'},
  {k:'credit', t:'Карта'},
  {k:'auto', t:'Авто'},
  {k:'mom', t:'Маме'},
  {k:'par', t:'Родителям'},
  {k:'mortgage',t:'Ипотека'},
  {k:'reserve', t:'Подушка'}
];

/* ---------- 3. Загружаем план + факт из localStorage ---------- */
let rows=JSON.parse(localStorage.getItem('finRows')||'null')||generateRows();

/* ---------- 4. Post-build helpers ---------- */
const tblWrap=document.getElementById('tblWrap');
renderTable(); drawCharts();

/* ---------- 5. Кнопки ---------- */
document.getElementById('saveBtn').onclick=()=>{localStorage.setItem('finRows',JSON.stringify(rows));alert('Сохранил!');};
document.getElementById('resetBtn').onclick=()=>{if(confirm('Очистить факт-данные?')){localStorage.removeItem('finRows');location.reload();}};
document.getElementById('exportBtn').onclick=()=>downloadCSV();

/* ---------- 6. Функции ---------- */
function generateRows(){
  const bal={...INIT_BAL};
  return planRows.map((p,i)=>{
    const mort=MORTGAGE;
    bal.ps5      = Math.max(0,bal.ps5      - p.ps5);
    bal.credit   = Math.max(0,bal.credit   - p.crMin - p.crX);
    bal.auto     = Math.max(0,bal.auto     - p.auto  - p.autoX);
    bal.mom      = Math.max(0,bal.mom      - p.mom);
    bal.par      = Math.max(0,bal.par      - p.par);
    bal.mortgage = Math.max(0,bal.mortgage - mort);
    bal.reserve  = bal.reserve + p.rez;

    return {
      id:i+1, m:p.m,
      ps5Pl:p.ps5,  ps5Fx:p.ps5,
      creditPl:p.crMin+p.crX, creditFx:p.crMin+p.crX,
      autoPl:p.auto+p.autoX,  autoFx:p.auto+p.autoX,
      momPl:p.mom, momFx:p.mom,
      parPl:p.par, parFx:p.par,
      mortgagePl:mort, mortgageFx:mort,
      reservePl:p.rez, reserveFx:p.rez,
      ps5Bal:bal.ps5, creditBal:bal.credit, autoBal:bal.auto,
      momBal:bal.mom, parBal:bal.par, mortgageBal:bal.mortgage,
      reserveBal:bal.reserve
    };
  });
}

function renderTable(){
  let html='<table><thead><tr><th rowspan="2">Месяц</th>';
  columns.forEach(c=>html+=`<th class="plan" colspan="2">${c.t}</th>`);html+='</tr><tr>';
  columns.forEach(()=>html+='<th class="plan">план</th><th class="fact">факт</th>');html+='</tr></thead><tbody>';

  rows.forEach((r,ri)=>{
    html+=`<tr><th style="text-align:left">${r.m}</th>`;
    columns.forEach(c=>{
      html+=`<td>${fmt(r[c.k+'Pl'])}</td>`
          +`<td class="edit" data-row="${ri}" data-field="${c.k+'Fx'}" contenteditable="false">${fmt(r[c.k+'Fx'])}</td>`;
    });
    html+='</tr>';
  });
  html+='</tbody></table>';
  tblWrap.innerHTML=html;

  tblWrap.querySelectorAll('td.edit').forEach(td=>{
    td.ondblclick=()=>{td.contentEditable='true';selectAll(td);}
    td.onblur=()=>{td.contentEditable='false';updateCell(td);}
  });
}

function updateCell(td){
  const ri=+td.dataset.row, field=td.dataset.field;
  rows[ri][field]=toNum(td.textContent);
  recalcBalances(); drawCharts(); // перерисовать
}

function recalcBalances(){
  const bal={...INIT_BAL};
  rows.forEach(r=>{
    bal.ps5      = Math.max(0,bal.ps5      - r.ps5Fx);
    bal.credit   = Math.max(0,bal.credit   - r.creditFx);
    bal.auto     = Math.max(0,bal.auto     - r.autoFx);
    bal.mom      = Math.max(0,bal.mom      - r.momFx);
    bal.par      = Math.max(0,bal.par      - r.parFx);
    bal.mortgage = Math.max(0,bal.mortgage - r.mortgageFx);
    bal.reserve  = bal.reserve + r.reserveFx;

    r.ps5Bal=bal.ps5; r.creditBal=bal.credit; r.autoBal=bal.auto;
    r.momBal=bal.mom; r.parBal=bal.par; r.mortgageBal=bal.mortgage;
    r.reserveBal=bal.reserve;
  });
}

function drawCharts(){
  const labels=rows.map(r=>r.m);
  const mk=(l,f,c)=>({label:l,data:rows.map(r=>r[f]),borderColor:c,borderWidth:2,tension:.25,fill:false,pointRadius:0});
  const cs=['#d62728','#ff7f0e','#2ca02c','#9467bd','#8c564b','#1f77b4'];

  /* debts */
  if(window.debtChart)window.debtChart.destroy();
  window.debtChart=new Chart(document.getElementById('debtChart'),{
    type:'line',
    data:{labels,datasets:[
      mk('PS5','ps5Bal',cs[0]), mk('Карта','creditBal',cs[1]), mk('Авто','autoBal',cs[2]),
      mk('Маме','momBal',cs[3]), mk('Родителям','parBal',cs[4]), mk('Ипотека','mortgageBal',cs[5])
    ]},
    options:{plugins:{title:{display:true,text:'Остатки долгов'}},scales:{y:{beginAtZero:true}}}
  });
  /* reserve */
  if(window.reserveChart)window.reserveChart.destroy();
  window.reserveChart=new Chart(document.getElementById('reserveChart'),{
    type:'line',
    data:{labels,datasets:[
      {label:'Подушка факт',data:rows.map(r=>r.reserveBal),
       borderColor:'#17becf',backgroundColor:'rgba(23,190,207,.12)',
       borderWidth:3,pointRadius:0,tension:.25,fill:true},
      {label:'Подушка план',data:rows.map(r=>r.reservePl),
       borderColor:'#17becf',borderDash:[4,4],borderWidth:1,pointRadius:0,tension:.25,fill:false}
    ]},
    options:{plugins:{title:{display:true,text:'Рост финансовой подушки'}},
             scales:{y:{beginAtZero:true}}}
  });
  document.getElementById('charts').classList.remove('hidden');
}

function downloadCSV(){
  let csv='Month,'+columns.map(c=>`${c.t}_plan,${c.t}_fact`).join(',')+'\n';
  rows.forEach(r=>{
    csv+=r.m+','+columns.map(c=>`${r[c.k+'Pl']},${r[c.k+'Fx']}`).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='fin_tracker.csv';a.click();URL.revokeObjectURL(url);
}

function selectAll(el){const r=document.createRange();r.selectNodeContents(el);const s=window.getSelection();s.removeAllRanges();s.addRange(r);}
function fmt(v){return Number(v).toLocaleString('ru-RU')}
function toNum(t){return Number(String(t).replace(/\s/g,'').replace(',','.'))||0}
</script>
</body>
</html>
