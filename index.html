<!DOCTYPE html><html lang="ru"><head>
<meta charset="UTF-8">
<title>Фин-трекер: долги и подушка</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
body{font-family:system-ui,Arial,sans-serif;margin:0;padding:2rem;background:#f4f6fa}
h1{margin:0 0 1rem}
#wrapper{max-width:1300px;margin:auto}
table{border-collapse:collapse;width:100%;font-size:.86rem;margin-top:1rem}
th,td{border:1px solid #bac3d6;padding:3px 5px;text-align:right}
th{background:#e6ecf5}
td.edit{cursor:pointer}
td.edit:focus{outline:2px solid #4e7ef8;background:#fff}
#controls{margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap}
button{padding:.4rem .8rem;border:1px solid #4e7ef8;background:#4e7ef8;color:#fff;border-radius:4px;cursor:pointer}
button.secondary{background:#fff;color:#4e7ef8}
button:disabled{opacity:.4;cursor:default}
#charts{display:flex;flex-wrap:wrap;gap:2rem;margin-top:2rem}
canvas{background:#fff;border:1px solid #bac3d6;padding:.4rem}
.hidden{display:none}
</style>
</head><body>
<div id="wrapper">
  <h1>Трекер долгов и финансовой подушки</h1>
  <input type="file" id="fileInput" accept=".csv">
  <div id="controls" class="hidden">
    <button id="saveBtn">Сохранить</button>
    <button id="resetBtn" class="secondary">Сбросить</button>
    <button id="exportBtn" class="secondary">Экспорт CSV</button>
  </div>
  <div id="tableContainer" class="hidden"></div>

  <div id="charts" class="hidden">
    <canvas id="debtChart" width="600" height="360"></canvas>
    <canvas id="reserveChart" width="600" height="360"></canvas>
  </div>
</div>

<script>
const FIELDS_NUMERIC = [
  'PS5_payment','Credit_min','Credit_extra','Auto_mand','Auto_extra',
  'Mother_payment','Parents_payment','Mortgage_mand','Mortgage_extra','Reserve_add',
  'PS5_balance','Credit_balance','Auto_balance','Mother_balance','Parents_balance',
  'Mortgage_balance','Reserve_balance'
];

const fileInput      = document.getElementById('fileInput');
const tableContainer = document.getElementById('tableContainer');
const chartsBlock    = document.getElementById('charts');
const saveBtn        = document.getElementById('saveBtn');
const resetBtn       = document.getElementById('resetBtn');
const exportBtn      = document.getElementById('exportBtn');
let rows=[], headers=[];
let debtChart, reserveChart;

initFromStorage(); // если данные уже сохранены

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,
    complete: res=>{rows=res.data; headers=res.meta.fields; initUI();}
  });
});

saveBtn.addEventListener('click', ()=>{
  localStorage.setItem('finTrackerRows', JSON.stringify(rows));
  alert('Данные сохранены в браузере');
});

resetBtn.addEventListener('click', ()=>{
  if(confirm('Очистить сохранённые данные и перезагрузить страницу?')){
    localStorage.removeItem('finTrackerRows');
    location.reload();
  }
});

exportBtn.addEventListener('click', ()=>{
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download='fin_tracker_export.csv';
  a.click(); URL.revokeObjectURL(url);
});

function initFromStorage(){
  const saved = localStorage.getItem('finTrackerRows');
  if(saved){
    rows = JSON.parse(saved);
    headers = Object.keys(rows[0]);
    initUI();
  }
}

function initUI(){
  buildTable();
  recalcBalances();
  drawCharts();
  document.getElementById('controls').classList.remove('hidden');
}

function buildTable(){
  tableContainer.innerHTML='';
  const tbl=document.createElement('table');
  // thead
  const thead=document.createElement('thead');
  const htr=document.createElement('tr');
  headers.forEach(h=>{
    const th=document.createElement('th'); th.textContent=h; htr.appendChild(th);
  });
  thead.appendChild(htr); tbl.appendChild(thead);
  // tbody
  const tbody=document.createElement('tbody');
  rows.forEach((r,ri)=>{
    const tr=document.createElement('tr');
    headers.forEach((h,ci)=>{
      const td=document.createElement('td');
      td.textContent=r[h];
      if(FIELDS_NUMERIC.includes(h)) td.classList.add('edit');
      // make editable for numeric input columns (payments & balances)
      td.addEventListener('dblclick', ()=>{
        if(!td.isContentEditable) td.contentEditable='true', td.focus();
      });
      td.addEventListener('blur', ()=>{
        if(td.isContentEditable){
          td.contentEditable='false';
          const val=td.textContent.replace(',','.'); // allow comma
          r[h]=FIELDS_NUMERIC.includes(h)?(parseFloat(val)||0):val;
          recalcBalances();
          drawCharts();
        }
      });
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  tableContainer.appendChild(tbl);
  tableContainer.classList.remove('hidden');
}

function recalcBalances(){
  // пересчитываем балансы на лету
  const init={
    PS5:28000, Credit:170000, Auto:1500000,
    Mother:400000, Parents:500000, Mortgage:2850508, Reserve:0
  };
  rows.forEach((r,i)=>{
    // начисления текущего месяца
    if(i===0){
      r.PS5_balance       = Math.max(0, init.PS5 - r.PS5_payment);
      r.Credit_balance    = Math.max(0, init.Credit - r.Credit_min - r.Credit_extra);
      r.Auto_balance      = Math.max(0, init.Auto - r.Auto_mand - r.Auto_extra);
      r.Mother_balance    = Math.max(0, init.Mother - r.Mother_payment);
      r.Parents_balance   = Math.max(0, init.Parents - r.Parents_payment);
      r.Mortgage_balance  = Math.max(0, init.Mortgage - r.Mortgage_mand - r.Mortgage_extra);
      r.Reserve_balance   = init.Reserve + r.Reserve_add;
    }else{
      const p=rows[i-1]; // предыдущая строка
      r.PS5_balance       = Math.max(0, p.PS5_balance - r.PS5_payment);
      r.Credit_balance    = Math.max(0, p.Credit_balance - r.Credit_min - r.Credit_extra);
      r.Auto_balance      = Math.max(0, p.Auto_balance - r.Auto_mand - r.Auto_extra);
      r.Mother_balance    = Math.max(0, p.Mother_balance - r.Mother_payment);
      r.Parents_balance   = Math.max(0, p.Parents_balance - r.Parents_payment);
      r.Mortgage_balance  = Math.max(0, p.Mortgage_balance - r.Mortgage_mand - r.Mortgage_extra);
      r.Reserve_balance   = p.Reserve_balance + r.Reserve_add;
    }
    // обновим ячейки в DOM
    const rowEl = tableContainer.querySelector('tbody').children[i];
    headers.forEach((h,ci)=>{
      if(FIELDS_NUMERIC.includes(h)){
        const cell=rowEl.children[ci];
        cell.textContent=r[h];
      }
    });
  });
}

function drawCharts(){
  const labels = rows.map(r=>r.Month);
  const buildDataset = (label,field,color) => ({
      label, data:rows.map(r=>r[field]),
      borderColor:color, pointRadius:0, tension:.25, borderWidth:2, fill:false
  });

  const colors=['#d62728','#ff7f0e','#2ca02c','#9467bd','#8c564b','#1f77b4'];

  // долги
  const debtData=[
    buildDataset('PS5','PS5_balance',colors[0]),
    buildDataset('Credit','Credit_balance',colors[1]),
    buildDataset('Auto','Auto_balance',colors[2]),
    buildDataset('Mother','Mother_balance',colors[3]),
    buildDataset('Parents','Parents_balance',colors[4]),
    buildDataset('Mortgage','Mortgage_balance',colors[5])
  ];
  if(debtChart) debtChart.destroy();
  debtChart = new Chart(document.getElementById('debtChart'),{
    type:'line',
    data:{labels,datasets:debtData},
    options:{plugins:{title:{display:true,text:'Остатки долгов'}},scales:{y:{beginAtZero:true}}}
  });

  // подушка
  if(reserveChart) reserveChart.destroy();
  reserveChart = new Chart(document.getElementById('reserveChart'),{
    type:'line',
    data:{labels,datasets:[{
      label:'Фонд резерва',data:rows.map(r=>r.Reserve_balance),
      borderColor:'#17becf',backgroundColor:'rgba(23,190,207,.12)',
      borderWidth:2,pointRadius:0,tension:.25,fill:true
    }]},
    options:{plugins:{title:{display:true,text:'Рост резервного фонда'}},scales:{y:{beginAtZero:true}}}
  });
  chartsBlock.classList.remove('hidden');
}
</script>
</body></html>
